description: >
  Start Android instance on Genymotion Cloud SaaS
parameters:
  recipe_uuid:
    type: string
    default: ""
    description: | 
      Instance recipe to use. Recipes can listed with command line 'gmsaas recipes list',
      or check on https://support.genymotion.com/hc/en-us/articles/360007473658-Supported-Android-devices-templates-for-Genymotion-Cloud-SaaS
      for comprehensive list of all currently available recipes UUIDs.

  adb_serial_port:
    type: string
    default: ""
    description: ADB serial port to use when the instance is connected to ADB.

steps:
  - run:
      name: Start Android instance
      command: |
        if [ -z "<< parameters.recipe_uuid >>" ]; then
          echo "Please set a recipe uuid"
          exit 1
        else
          INSTANCE_UUID=$(gmsaas instances start << parameters.recipe_uuid >> CircleCI-device-$CIRCLE_BUILD_NUM )
          echo "export INSTANCE_UUID=$INSTANCE_UUID" >> $BASH_ENV
        fi

        if [ -z "<< parameters.adb_serial_port >>" ]; then
          # Connect Android instance with a random port
          gmsaas instances adbconnect $INSTANCE_UUID

        else
          # Connect Android instance with the specified port
          gmsaas instances adbconnect $INSTANCE_UUID --adb-serial-port << parameters.adb_serial_port >>
        fi
